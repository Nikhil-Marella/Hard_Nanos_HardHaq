import mph
from pathlib import Path
import sys

# --- Baseline values from your COMSOL GUI ---
baseline_values = {
    "V_rf": 300,
    "V_dc": 50,
    "V_endcap": 10,
    "rod_spacing": 0.005,
    "rod_radius": 0.002,
    "rod_length": 0.04,
    "endcap_offset": 0.01
}

def find_model_file(preferred_name: str = "3d_pole_trap - Copy.mph") -> Path:
    cwd = Path(__file__).resolve().parent
    preferred_path = cwd / preferred_name
    if preferred_path.exists():
        print(f"Using model file: {preferred_path}")
        return preferred_path

    candidates = list(cwd.glob("*.mph"))
    if candidates:
        print("Preferred model not found. Available .mph files in the folder:")
        for i, p in enumerate(candidates, 1):
            print(f"  {i}. {p.name}")
        fallback = candidates[0]
        print(f"Falling back to: {fallback}")
        return fallback

    print(f"No .mph model file found in {cwd}. Please place your COMSOL model there or provide the correct path.")
    sys.exit(2)

def main():
    model_path = find_model_file()
    print("Starting COMSOL client...")
    client = mph.start(cores=8, version="6.3") #THE CORE COUNT IS SO IMPORTANT GODDAMNIT KEEP IT 8

    try:
        print(f"Loading model: {model_path}")
        model = client.load(str(model_path))

        # --- Print all COMSOL parameters (expression + value) ---
        print("\nðŸ“‹ All COMSOL parameters:")
        exprs = model.parameters()
        for name, expr in exprs.items():
            val = model.parameter(name)
            print(f"  {name:<20} | Expression: {expr:<10} | Value: {val}")

        # --- Run the active study ---
        print("\nðŸš€ Running default study...")
        model.solve()

        # --- Evaluate GUI-style variables ---
        def try_eval(name):
            try:
                return float(model.evaluate(name))
            except Exception:
                return None

        print("\nðŸ“Š GUI-aligned results:")
        depth_eV   = try_eval("depth_eV")
        min_eV     = try_eval("minU_eV")
        max_eV     = try_eval("maxU_eV")
        trap_x     = try_eval("trap_x")
        trap_y     = try_eval("trap_y")
        trap_z     = try_eval("trap_z")
        offset_mm  = try_eval("offset_mm")
        offset_m   = try_eval("offset_m")
        P_est_mW   = try_eval("P_est_mW")

        print(f"  depth_eV     = {depth_eV}")
        print(f"  min_eV       = {min_eV}")
        print(f"  max_eV       = {max_eV}")
        print(f"  trap_x       = {trap_x}")
        print(f"  trap_y       = {trap_y}")
        print(f"  trap_z       = {trap_z}")
        print(f"  offset_mm    = {offset_mm}")
        print(f"  offset_m     = {offset_m}")
        print(f"  P_est_mW     = {P_est_mW}")

        model.save()
        client.remove(model)

    except Exception as e:
        print("âŒ Exception occurred:")
        print(e)
        try:
            client.remove_all()
        except Exception:
            pass
        raise

if __name__ == "__main__":
    main()